<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      About Libtool Archive (.la) files
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL-NS Stylesheets Vsnapshot" />
    <style type="text/css">
    /*<![CDATA[*/
    body { background-image: url('images/draft.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }
    /*]]>*/
    </style>
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="blfs" id="blfs-r12.0-1055+">
    <div class="navheader">
      <h4>
        Beyond Linux<sup>®</sup> From Scratch <span class=
        "phrase">(systemd</span> 版) - Version r12.0-1055+
      </h4>
      <h3>
        第2章 重要な情報
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="systemd-units.html" title=
          "BLFS Systemd ユニット">戻る</a>
          <p>
            BLFS Systemd ユニット
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="libraries.html" title=
          "ライブラリはスタティックか共有か">次へ</a>
          <p>
            ライブラリはスタティックか共有か
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="important.html" title="第2章 重要な情報">上に戻る</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch  (systemd  版) - Version r12.0-1055+">ホーム</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="ja" xml:lang="ja">
      <h1 class="sect1">
        <a id="la-files" name="la-files"></a>About Libtool Archive (.la)
        files
      </h1>
      <div class="package" lang="ja" xml:lang="ja">
        <h2 class="sect2">
          Files with a .la extension
        </h2>
        <p>
          In LFS and BLFS, many packages use a internally shipped libtool
          copy to build on a variety of Unix platforms. This includes
          platforms such as AIX, Solaris, IRIX, HP-UX, and Cygwin as well as
          Linux. The origins of this tool are quite dated. It was intended to
          manage libraries on systems with less advanced capabilities than a
          modern Linux system.
        </p>
        <p>
          On a Linux system, libtool specific files are generally unneeded.
          Normally libraries are specified in the build process during the
          link phase. Since a linux system uses the <a class="ulink" href=
          "https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">Executable
          and Linkable Format (ELF)</a> for executables and dynamic
          libraries, information needed to complete the task is embedded in
          the files. Both the linker and the program loader can query the
          appropriate files and properly link or execute the program.
        </p>
        <p>
          Static libraries are rarely used in LFS and BLFS. And, nowadays
          most packages store the information needed for linking against a
          static library into a .pc file, instead of relying on libtool. A
          <span class="command"><strong>pkg-config --static
          --libs</strong></span> command will output the sufficient flags for
          the linker to link against a static library without any libtool
          magic.
        </p>
        <p>
          The problem is that libtool usually creates one or more text files
          for package libraries called libtool archives. These small files
          have a ".la" extension and contain information that is similar to
          that embedded in the libraries or pkg-config files. When building a
          package that uses libtool, the process automatically looks for
          these files. Sometimes a .la file can contains the name or path of
          a static library used during build but not installed, then the
          build process will break because the .la file refers to something
          nonexistent on the system. Similarly, if a package is updated and
          no longer uses the .la file, then the build process can break with
          the old .la files.
        </p>
        <p>
          The solution is to remove the .la files. However there is a catch.
          Some packages, such as <a class="xref" href=
          "../general/imagemagick.html" title=
          "ImageMagick-7.1.1-15">ImageMagick-7.1.1-15</a>, use a libtool
          function, lt_dlopen, to load libraries as needed during execution
          and resolve their dependencies at run time. In this case, the .la
          files should remain.
        </p>
        <p>
          The script below, removes all unneeded .la files and saves them in
          a directory, /var/local/la-files by default, not in the normal
          library path. It also searches all pkg-config files (.pc) for
          embedded references to .la files and fixes them to be conventional
          library references needed when an application or library is built.
          It can be run as needed to clean up the directories that may be
          causing problems.
        </p>
        <pre class="root"><kbd class=
        "command">cat &gt; /usr/sbin/remove-la-files.sh &lt;&lt; "EOF"
<code class="literal">#!/bin/bash

# /usr/sbin/remove-la-files.sh
# Written for Beyond Linux From Scratch
# by Bruce Dubbs &lt;bdubbs@linuxfromscratch.org&gt;

# Make sure we are running with root privs
if test "${EUID}" -ne 0; then
    echo "Error: $(basename ${0}) must be run as the root user! Exiting..."
    exit 1
fi

# Make sure PKG_CONFIG_PATH is set if discarded by sudo
source /etc/profile

OLD_LA_DIR=/var/local/la-files

mkdir -p $OLD_LA_DIR

# Only search directories in /opt, but not symlinks to directories
OPTDIRS=$(find /opt -mindepth 1 -maxdepth 1 -type d)

# Move any found .la files to a directory out of the way
find /usr/lib $OPTDIRS -name "*.la" ! -path "/usr/lib/ImageMagick*" \
  -exec mv -fv {} $OLD_LA_DIR \;
###############

# Fix any .pc files that may have .la references

STD_PC_PATH='/usr/lib/pkgconfig
             /usr/share/pkgconfig
             /usr/local/lib/pkgconfig
             /usr/local/share/pkgconfig'

# For each directory that can have .pc files
for d in $(echo $PKG_CONFIG_PATH | tr : ' ') $STD_PC_PATH; do

  # For each pc file
  for pc in $d/*.pc ; do
    if [ $pc == "$d/*.pc" ]; then continue; fi

    # Check each word in a line with a .la reference
    for word in $(grep '\.la' $pc); do
      if $(echo $word | grep -q '.la$' ); then
        mkdir -p $d/la-backup
        cp -fv  $pc $d/la-backup

        basename=$(basename $word )
        libref=$(echo $basename|sed -e 's/^lib/-l/' -e 's/\.la$//')

        # Fix the .pc file
        sed -i "s:$word:$libref:" $pc
      fi
    done
  done
done</code>

EOF

chmod +x /usr/sbin/remove-la-files.sh</kbd></pre>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="systemd-units.html" title=
          "BLFS Systemd ユニット">戻る</a>
          <p>
            BLFS Systemd ユニット
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="libraries.html" title=
          "ライブラリはスタティックか共有か">次へ</a>
          <p>
            ライブラリはスタティックか共有か
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="important.html" title="第2章 重要な情報">上に戻る</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch  (systemd  版) - Version r12.0-1055+">ホーム</a>
        </li>
      </ul>
    </div>
  </body>
</html>
